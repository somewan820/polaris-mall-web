name: web-ci-cd

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  router-guard-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Router Guard Test
        run: node tests/router_guard_test.js

  catalog-logic-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Catalog Logic Test
        run: node tests/catalog_logic_test.js

  checkout-payload-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Checkout Payload Test
        run: node tests/checkout_payload_test.js

  payment-logic-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run Payment Logic Test
        run: node tests/payment_logic_test.js

  gate:
    runs-on: ubuntu-latest
    if: always()
    needs:
      - router-guard-test
      - catalog-logic-test
      - checkout-payload-test
      - payment-logic-test
    steps:
      - name: Enforce Gate
        run: |
          set -euo pipefail
          if [[ "${{ needs.router-guard-test.result }}" != "success" || \
                "${{ needs.catalog-logic-test.result }}" != "success" || \
                "${{ needs.checkout-payload-test.result }}" != "success" || \
                "${{ needs.payment-logic-test.result }}" != "success" ]]; then
            echo "Gate failed."
            exit 1
          fi
          echo "Gate passed."

  deploy-dev:
    runs-on: ubuntu-latest
    needs: gate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Simulate Dev Deploy
        run: |
          echo "Deploying web static assets to dev..."
          echo "Replace this with real deploy command."
